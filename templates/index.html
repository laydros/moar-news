<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moar News</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <header class="site-header">
        <h1>Moar News</h1>
        <div id="refresh-container">
            <button
                hx-post="/refresh"
                hx-target="#refresh-container"
                hx-swap="innerHTML"
                class="refresh-btn"
            >
                Refresh All
            </button>
        </div>
    </header>

    <main class="feeds-grid">
        {% for feed_data in feeds %}
        <section class="feed-column">
            <header class="feed-header">
                <h2>{{ feed_data.feed.name }}</h2>
                {% if let Some(error) = feed_data.feed.last_error %}
                <span class="feed-error" title="{{ error }}">!</span>
                {% endif %}
            </header>

            <div class="feed-content">
                <ul class="items-list" id="feed-{{ feed_data.feed.id }}-items">
                    {% for item in feed_data.items %}
                    <li class="item">
                        <a href="{{ item.link }}" target="_blank" rel="noopener" class="item-link">
                            {{ item.title }}
                        </a>
                        {% if let Some(discussion) = item.discussion_link %}
                        <a href="{{ discussion }}" target="_blank" rel="noopener" class="discussion-link" title="Discussion">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                                <path d="M21 6h-2v9H6v2c0 .55.45 1 1 1h11l4 4V7c0-.55-.45-1-1-1zm-4 6V3c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v14l4-4h10c.55 0 1-.45 1-1z"/>
                            </svg>
                        </a>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>

                {% if feed_data.has_more %}
                <div class="load-more-container" id="feed-{{ feed_data.feed.id }}-more">
                    <button
                        hx-get="/feed/{{ feed_data.feed.id }}/more?offset=15"
                        hx-target="this"
                        hx-swap="outerHTML"
                        class="load-more-btn"
                    >
                        Show More
                    </button>
                    <button
                        class="load-more-btn show-less-btn hidden"
                        onclick="toggleShowLess(this, {{ feed_data.feed.id }})"
                    >
                        Show Less
                    </button>
                </div>
                {% endif %}
            </div>
        </section>
        {% endfor %}
    </main>

    <footer class="site-footer">
        <p>Powered by RSS</p>
    </footer>

    <script>
        function toggleShowLess(btn, feedId) {
            const itemsList = document.getElementById(`feed-${feedId}-items`);
            const extraItems = itemsList.querySelectorAll('.extra-item');
            const container = btn.closest('.load-more-container, .load-more-buttons');

            // Hide all extra items
            extraItems.forEach(item => item.classList.add('hidden'));

            // Hide the Show Less button
            btn.classList.add('hidden');

            // Find or create a Show More button that reveals hidden items
            let showMoreBtn = container.querySelector('.show-more-toggle');
            if (!showMoreBtn) {
                showMoreBtn = document.createElement('button');
                showMoreBtn.className = 'load-more-btn show-more-toggle';
                showMoreBtn.textContent = 'Show More';
                showMoreBtn.onclick = function() {
                    // Show the hidden extra items
                    extraItems.forEach(item => item.classList.remove('hidden'));
                    // Hide this button, show the Show Less button
                    this.classList.add('hidden');
                    btn.classList.remove('hidden');
                };
                container.insertBefore(showMoreBtn, container.firstChild);
            } else {
                showMoreBtn.classList.remove('hidden');
            }

            // Hide the HTMX load more button if it exists (we're using toggle now)
            const htmxBtn = container.querySelector('[hx-get]');
            if (htmxBtn) {
                htmxBtn.classList.add('hidden');
            }
        }

        // After HTMX loads new items, show the Show Less button
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            // Find the container that was updated
            const container = evt.detail.target.closest('.load-more-container, .load-more-buttons');
            if (container) {
                const showLessBtn = container.querySelector('.show-less-btn');
                if (showLessBtn) {
                    showLessBtn.classList.remove('hidden');
                }
                // Hide any show-more-toggle buttons (used after Show Less was clicked)
                const toggleBtn = container.querySelector('.show-more-toggle');
                if (toggleBtn) {
                    toggleBtn.classList.add('hidden');
                }
            }
        });
    </script>
</body>
</html>
